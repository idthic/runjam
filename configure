#!/usr/bin/env bash

PACKAGE_VERSION=0.3.0-alpha
libjam_PREFIX=~/opt/jam/1.820
libjam_MXV=200000
CXX=g++

function readargs/option:with-jam {
  if [[ -f $1/lib/libjam.a || -f $f/lib/libjam.so ]]; then
    libjam_PREFIX=$1
  else
    echo "configure: jam not fond at '$1'" >&2
    flags=E$flags
  fi
}
function readargs/option:help {
  printf '%s\n' \
         'usage: configure [OPTION|VAR=VAL]...' \
         '' \
         'OPTION' \
         '  --prefix=DIR' \
         '  --with-jam=DIR' \
         ''
}

## @fn readargs
##   @var[out] flags
##   @var[out] PREFIX
##   @var[out] libjam_PREFIX
function readargs {
  flags=
  PREFIX=~/.opt/idt
  libjam_PREFIX=
  while (($#)); do
    local arg=$1; shift
    if [[ $flags != *R* ]]; then
      if local rex='^[[:alnum:]_]+='; [[ $arg =~ $rex ]]; then
        printf -v "${arg%%=*}" %s "${arg#*=}"
      elif [[ $arg == -* ]]; then
        case $arg in
        (--prefix=*) PREFIX=${arg#*=} ;;
        (--prefix)   PREFIX=$1; shift ;;
        (--with-jam=*) readargs/option:with-jam "${arg#*=}" ;;
        (--with-jam)   readargs/option:with-jam "$1"; shift ;;
        (--help)
          readargs/option:help
          flags=H$flags ;;
        (*)
          echo "configure: unknown option '$arg'" >&2
          flags=E$flags ;;
        esac
      else
        echo "configure: unrecognized argument '$arg'" >&2
        flags=E$flags
      fi
    fi
  done

  [[ $libjam_PREFIX ]] ||
    readargs/option:with-jam $HOME/opt/jam/1.820 ||
    readargs/option:with-jam $HOME/opt/jam-1.820 ||
    flags=E$flags

  : "${PREFIX:-/usr}"
  [[ $flags != *E* ]]
}

function main {
  local flags libjam_PREFIX
  readargs "$@" || return 1
  [[ $flags == *H* ]] && return 0
  echo ---------------------------------------
  {
    echo '# -*- mode: makefile-gmake -*-'
    echo
    {
      echo "configure := ./configure $*"
      echo "PREFIX    := $PREFIX"
      echo "CXX       := $CXX"
      echo "CPPFLAGS  := $CPPFLAGS"
      echo "CXXFLAGS  := $CXXFLAGS"
      echo "LDFLAGS   := $LDFLAGS"
      echo "LIBS      := $LIBS"
      echo "libjam_PREFIX := $libjam_PREFIX"
      echo "libjam_MXV    := $libjam_MXV"
    } | tee /dev/tty
  } > config.mk

  {
    echo "#ifndef CONFIG_HPP"
    echo "#define CONFIG_HPP"
    echo "#define PACKAGE_VERSION \"$PACKAGE_VERSION\""
    echo "#define PACKAGE_PREFIX  \"$PREFIX\""
    echo "#define PACKAGE_BUILD   \"$PWD\""
    echo "#define CONFIG_JAM_MXV  $libjam_MXV"
    echo 'namespace idt {'
    echo 'namespace runjam {'
    echo '  extern const char* package_hash;'
    echo '}'
    echo '}'
    echo "#endif"
  } > config.hpp

  {
    echo '#include "config.hpp"'
    echo 'namespace idt {'
    echo 'namespace runjam {'
    echo '  const char* package_hash = "";'
    echo '}'
    echo '}'
  } > config.cpp
  ./mktool.sh update-commit-hash
  echo ---------------------------------------
}

main "$@"
