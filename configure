#!/usr/bin/env bash

PACKAGE_VERSION=0.3.0-alpha

CXX=g++

use_libjam1=yes
libjam1_PREFIX=~/opt/jam/1.820
libjam1_MXV=200000

use_libjam2=yes
libjam2_PREFIX=~/.opt/jam/dev
pythia8_PREFIX=~/.opt/pythia/8.244mod

function readargs/option:with-jam {
  if [[ -f $1/lib/libjam.a || -f $f/lib/libjam.so ]]; then
    libjam1_PREFIX=$1
  else
    echo "configure: jam not fond at '$1'" >&2
    flags=E$flags
  fi
}
function readargs/option:help {
  printf '%s\n' \
         'usage: configure [OPTION|VAR=VAL]...' \
         '' \
         'OPTION' \
         '  --prefix=DIR' \
         '  --with-jam=DIR' \
         ''
}

## @fn readargs
##   @var[out] flags
##   @var[out] PREFIX
##   @var[out] libjam1_PREFIX
function readargs {
  flags=
  PREFIX=~/.opt/idt
  libjam1_PREFIX=
  while (($#)); do
    local arg=$1; shift
    if [[ $flags != *R* ]]; then
      if local rex='^[[:alnum:]_]+='; [[ $arg =~ $rex ]]; then
        printf -v "${arg%%=*}" %s "${arg#*=}"
      elif [[ $arg == -* ]]; then
        case $arg in
        (--prefix=*) PREFIX=${arg#*=} ;;
        (--prefix)   PREFIX=$1; shift ;;
        (--with-jam=*) readargs/option:with-jam "${arg#*=}" ;;
        (--with-jam)   readargs/option:with-jam "$1"; shift ;;
        (--help)
          readargs/option:help
          flags=H$flags ;;
        (*)
          echo "configure: unknown option '$arg'" >&2
          flags=E$flags ;;
        esac
      else
        echo "configure: unrecognized argument '$arg'" >&2
        flags=E$flags
      fi
    fi
  done

  [[ $libjam1_PREFIX ]] ||
    readargs/option:with-jam $HOME/opt/jam/1.820 ||
    readargs/option:with-jam $HOME/opt/jam-1.820 ||
    flags=E$flags

  : "${PREFIX:-/usr}"
  [[ $flags != *E* ]]
}

function main {
  local flags libjam1_PREFIX
  readargs "$@" || return 1
  [[ $flags == *H* ]] && return 0
  echo ---------------------------------------
  {
    echo '# -*- mode: makefile-gmake -*-'
    echo
    {
      echo "configure := ./configure $*"
      echo "PREFIX    := $PREFIX"
      echo "CXX       := $CXX"
      echo "CPPFLAGS  := $CPPFLAGS"
      echo "CXXFLAGS  := $CXXFLAGS"
      echo "LDFLAGS   := $LDFLAGS"
      echo "LIBS      := $LIBS"
      echo "use_libjam1 := $use_libjam1"
      echo "ifneq (\$(use_libjam1),)"
      echo "  libjam1_PREFIX := $libjam1_PREFIX"
      echo "  libjam1_MXV    := $libjam1_MXV"
      echo "endif"
      echo "use_libjam2 := $use_libjam2"
      echo "ifneq (\$(use_libjam2),)"
      echo "  libjam2_PREFIX := $libjam2_PREFIX"
      echo "  pythia8_PREFIX := $pythia8_PREFIX"
      echo "endif"
    } | tee /dev/tty
  } > config.mk

  {
    echo "#ifndef CONFIG_HPP"
    echo "#define CONFIG_HPP"
    echo "#define PACKAGE_VERSION \"$PACKAGE_VERSION\""
    echo "#define PACKAGE_PREFIX  \"$PREFIX\""
    echo "#define PACKAGE_BUILD   \"$PWD\""
    if [[ $use_libjam1 ]]; then
      echo "#define USE_LIBJAM1 1"
      echo "#define CONFIG_JAM_MXV $libjam1_MXV"
    else
      echo "#undef USE_LIBJAM1"
    fi
    if [[ $use_libjam2 ]]; then
      echo "#define USE_LIBJAM2 1"
      echo "#define Pythia8_PREFIX \"$pythia8_PREFIX\""
    else
      echo "#undef USE_LIBJAM2"
    fi
    if [[ $use_libjam2 ]]; then
      echo "#define DEFAULT_JAM_VERSION 2"
    elif [[ $use_libjam1 ]]; then
      echo "#define DEFAULT_JAM_VERSION 1"
    else
      echo "#define DEFAULT_JAM_VERSION 0"
    fi
    echo 'namespace idt {'
    echo 'namespace runjam {'
    echo '  extern const char* package_hash;'
    echo '}'
    echo '}'
    echo "#endif"
  } > config.hpp

  {
    echo '#include "config.hpp"'
    echo 'namespace idt {'
    echo 'namespace runjam {'
    echo '  const char* package_hash = "";'
    echo '}'
    echo '}'
  } > config.cpp
  ./mktool.sh update-commit-hash
  echo ---------------------------------------
}

main "$@"
